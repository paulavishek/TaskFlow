<!-- templates/kanban/dependency_tree.html -->
{% extends 'base.html' %}

{% block title %}Task Dependency Tree - {{ task.title }}{% endblock %}

{% block extra_css %}
<style>
    .dependency-tree {
        font-family: 'Arial', sans-serif;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 20px 0;
    }

    .tree-node {
        display: flex;
        flex-direction: column;
        margin: 10px 0;
        padding: 15px;
        background: white;
        border-left: 4px solid #007bff;
        border-radius: 4px;
        position: relative;
    }

    .tree-node.parent {
        border-left-color: #28a745;
    }

    .tree-node.child {
        border-left-color: #6f42c1;
        margin-left: 30px;
    }

    .tree-node.related {
        border-left-color: #ffc107;
    }

    .tree-node-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .tree-node-title {
        font-weight: bold;
        color: #333;
        font-size: 16px;
    }

    .tree-node-status {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
    }

    .tree-node-status.todo {
        background: #e9ecef;
        color: #495057;
    }

    .tree-node-status.inprogress {
        background: #cfe2ff;
        color: #084298;
    }

    .tree-node-status.done {
        background: #d1e7dd;
        color: #0f5132;
    }

    .tree-node-meta {
        font-size: 12px;
        color: #6c757d;
        display: flex;
        gap: 20px;
        margin-top: 8px;
    }

    .tree-node-actions {
        margin-top: 10px;
        display: flex;
        gap: 5px;
    }

    .tree-node-actions button {
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        border: 1px solid #ddd;
        background: white;
        border-radius: 3px;
    }

    .tree-node-actions button:hover {
        background: #f8f9fa;
    }

    .tree-children {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #dee2e6;
    }

    .tree-section {
        margin: 20px 0;
    }

    .tree-section-title {
        font-size: 14px;
        font-weight: bold;
        color: #495057;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 15px 0 10px 0;
        padding-bottom: 5px;
        border-bottom: 2px solid #dee2e6;
    }

    .dependency-level-indicator {
        display: inline-block;
        background: #6f42c1;
        color: white;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 10px;
    }

    .dependency-info {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
    }

    .dependency-info strong {
        color: #0056b3;
    }

    .analyze-btn {
        background: #0d6efd;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }

    .analyze-btn:hover {
        background: #0b5ed7;
    }

    .suggestions-panel {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 15px;
        margin: 15px 0;
    }

    .suggestion-item {
        background: white;
        padding: 10px;
        margin: 8px 0;
        border-radius: 3px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .confidence-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    .confidence-high {
        background: #d1e7dd;
        color: #0f5132;
    }

    .confidence-medium {
        background: #fff3cd;
        color: #664d03;
    }

    .confidence-low {
        background: #f8d7da;
        color: #842029;
    }

    .graph-container {
        background: white;
        border-radius: 4px;
        padding: 15px;
        margin: 15px 0;
        border: 1px solid #dee2e6;
    }

    .placeholder {
        text-align: center;
        color: #6c757d;
        padding: 20px;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dependency Tree: {{ task.title }}</h1>
        <a href="{% url 'task_detail' task.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Task
        </a>
    </div>

    <!-- Task Information Card -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">{{ task.title }}</h5>
            <p class="card-text">{{ task.description }}</p>
            <div class="row mt-3">
                <div class="col-md-3">
                    <strong>Status:</strong> {{ task.column.name }}
                </div>
                <div class="col-md-3">
                    <strong>Priority:</strong> <span class="badge bg-{{ task.priority|lower }}">{{ task.get_priority_display }}</span>
                </div>
                <div class="col-md-3">
                    <strong>Assigned To:</strong> {{ task.assigned_to.username|default:"Unassigned" }}
                </div>
                <div class="col-md-3">
                    <strong>Dependency Level:</strong> {{ dependency_level }}
                </div>
            </div>
        </div>
    </div>

    <!-- Analyze Dependencies Button -->
    <div class="mb-4">
        <button class="analyze-btn" onclick="analyzeDependencies({{ task.id }})">
            <i class="bi bi-lightning"></i> Analyze Dependencies
        </button>
        <span id="analyze-status" class="ms-3" style="display: none;">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Analyzing...
        </span>
    </div>

    <!-- Dependency Tree Visualization -->
    <div class="dependency-tree">
        {% if parent_task %}
        <div class="tree-section">
            <div class="tree-section-title">Parent Task</div>
            <div class="tree-node parent">
                <div class="tree-node-header">
                    <div class="tree-node-title">
                        <a href="{% url 'task_detail' parent_task.id %}">{{ parent_task.title }}</a>
                    </div>
                    <span class="tree-node-status">{{ parent_task.column.name }}</span>
                </div>
                <div class="tree-node-meta">
                    <span>
                        <i class="bi bi-person-circle"></i> 
                        {{ parent_task.assigned_to.username|default:"Unassigned" }}
                    </span>
                    <span>
                        <i class="bi bi-calendar"></i> 
                        {{ parent_task.due_date|date:"M d, Y"|default:"No due date" }}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}

        {% if subtasks %}
        <div class="tree-section">
            <div class="tree-section-title">Subtasks ({{ subtasks|length }})</div>
            {% for subtask in subtasks %}
            <div class="tree-node child">
                <div class="tree-node-header">
                    <div class="tree-node-title">
                        <a href="{% url 'task_detail' subtask.id %}">{{ subtask.title }}</a>
                        <span class="dependency-level-indicator">Level {{ subtask.get_dependency_level }}</span>
                    </div>
                    <span class="tree-node-status">{{ subtask.column.name }}</span>
                </div>
                <div class="tree-node-meta">
                    <span>
                        <i class="bi bi-person-circle"></i> 
                        {{ subtask.assigned_to.username|default:"Unassigned" }}
                    </span>
                    <span>
                        <i class="bi bi-calendar"></i> 
                        {{ subtask.due_date|date:"M d, Y"|default:"No due date" }}
                    </span>
                </div>
                {% if subtask.subtasks.all %}
                <div class="tree-children">
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">
                        <strong>Has {{ subtask.subtasks.count }} child task{{ subtask.subtasks.count|pluralize }}</strong>
                    </div>
                    {% for grandchild in subtask.subtasks.all %}
                    <div class="tree-node child" style="margin-left: 60px;">
                        <div class="tree-node-header">
                            <div class="tree-node-title">
                                <a href="{% url 'task_detail' grandchild.id %}">{{ grandchild.title }}</a>
                                <span class="dependency-level-indicator">Level {{ grandchild.get_dependency_level }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if related_tasks %}
        <div class="tree-section">
            <div class="tree-section-title">Related Tasks ({{ related_tasks|length }})</div>
            {% for related in related_tasks %}
            <div class="tree-node related">
                <div class="tree-node-header">
                    <div class="tree-node-title">
                        <a href="{% url 'task_detail' related.id %}">{{ related.title }}</a>
                    </div>
                    <span class="tree-node-status">{{ related.column.name }}</span>
                </div>
                <div class="tree-node-meta">
                    <span>
                        <i class="bi bi-person-circle"></i> 
                        {{ related.assigned_to.username|default:"Unassigned" }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if not parent_task and not subtasks and not related_tasks %}
        <div class="placeholder">
            <p>No dependencies configured for this task yet.</p>
            <p>Click "Analyze Dependencies" above to get AI suggestions.</p>
        </div>
        {% endif %}
    </div>

    <!-- AI Suggestions Panel -->
    <div id="suggestions-container"></div>

</div>

<script>
const TASK_ID = {{ task.id }};

async function analyzeDependencies(taskId) {
    const statusElement = document.getElementById('analyze-status');
    const suggestionsContainer = document.getElementById('suggestions-container');
    
    statusElement.style.display = 'inline';
    suggestionsContainer.innerHTML = '';
    
    try {
        const response = await fetch(`/kanban/api/task/${taskId}/analyze-dependencies/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ auto_link: false })
        });
        
        if (!response.ok) throw new Error('Analysis failed');
        
        const data = await response.json();
        displaySuggestions(data.analysis);
        
    } catch (error) {
        suggestionsContainer.innerHTML = `
            <div class="alert alert-danger" role="alert">
                Error analyzing dependencies: ${error.message}
            </div>
        `;
    } finally {
        statusElement.style.display = 'none';
    }
}

function displaySuggestions(analysis) {
    const container = document.getElementById('suggestions-container');
    let html = '<div class="suggestions-panel">';
    html += '<h5><i class="bi bi-stars"></i> AI Suggestions</h5>';
    
    // Parent suggestions
    if (analysis.parent_suggestions && analysis.parent_suggestions.length > 0) {
        html += '<div class="mt-3"><strong>Potential Parent Tasks:</strong></div>';
        analysis.parent_suggestions.forEach(suggestion => {
            const confidence = suggestion.confidence * 100;
            const confidenceClass = confidence > 0.7 ? 'confidence-high' : 
                                   confidence > 0.5 ? 'confidence-medium' : 'confidence-low';
            html += `
                <div class="suggestion-item">
                    <div>
                        <strong>${suggestion.task_title}</strong>
                        <div style="font-size: 12px; color: #6c757d;">${suggestion.reason}</div>
                    </div>
                    <div>
                        <span class="confidence-badge ${confidenceClass}">${(confidence).toFixed(1)}%</span>
                        <button class="btn btn-sm btn-primary ms-2" 
                                onclick="linkAsParent(${suggestion.task_id})">
                            Link
                        </button>
                    </div>
                </div>
            `;
        });
    }
    
    // Related suggestions
    if (analysis.related_suggestions && analysis.related_suggestions.length > 0) {
        html += '<div class="mt-3"><strong>Related Tasks:</strong></div>';
        analysis.related_suggestions.forEach(suggestion => {
            const confidence = suggestion.confidence * 100;
            const confidenceClass = confidence > 0.7 ? 'confidence-high' : 
                                   confidence > 0.5 ? 'confidence-medium' : 'confidence-low';
            html += `
                <div class="suggestion-item">
                    <div>
                        <strong>${suggestion.task_title}</strong>
                        <div style="font-size: 12px; color: #6c757d;">${suggestion.reason}</div>
                    </div>
                    <div>
                        <span class="confidence-badge ${confidenceClass}">${(confidence).toFixed(1)}%</span>
                        <button class="btn btn-sm btn-info ms-2" 
                                onclick="linkAsRelated(${suggestion.task_id})">
                            Link
                        </button>
                    </div>
                </div>
            `;
        });
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function linkAsParent(parentId) {
    const taskId = TASK_ID;
    try {
        const response = await fetch(`/kanban/api/task/${taskId}/set-parent/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ parent_task_id: parentId })
        });
        
        if (!response.ok) throw new Error('Failed to link parent');
        
        alert('Parent task linked successfully! Reloading...');
        location.reload();
        
    } catch (error) {
        alert('Error linking parent task: ' + error.message);
    }
}

async function linkAsRelated(relatedId) {
    const taskId = TASK_ID;
    try {
        const response = await fetch(`/kanban/api/task/${taskId}/add-related/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ related_task_id: relatedId })
        });
        
        if (!response.ok) throw new Error('Failed to link related task');
        
        alert('Related task linked successfully! Reloading...');
        location.reload();
        
    } catch (error) {
        alert('Error linking related task: ' + error.message);
    }
}
</script>

{% endblock %}
