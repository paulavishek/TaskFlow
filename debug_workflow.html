<!DOCTYPE html>
<html>
<head>
    <title>Debug Workflow Optimization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
</head>
<body>
    <h1>Debug Workflow Optimization</h1>
    
    <button id="analyze-workflow-btn" data-board-id="1">
        <span id="workflow-ai-spinner" class="d-none">Loading...</span>
        Analyze Workflow
    </button>
    
    <div id="workflow-optimization-container" class="d-none">
        <div id="workflow-optimization-content"></div>
    </div>
    
    <div id="workflow-optimization-placeholder">
        <p>Click "Analyze Workflow" to get AI-powered optimization recommendations</p>
    </div>

    <script>
        // Simulate CSRF token
        window.CSRF_TOKEN = 'test-csrf-token';
        
        // Add meta tag
        const meta = document.createElement('meta');
        meta.name = 'csrf-token';
        meta.content = 'test-csrf-token';
        document.head.appendChild(meta);
        
        console.log('Debug page loaded');
        console.log('Button found:', document.getElementById('analyze-workflow-btn'));
        console.log('CSRF token:', window.CSRF_TOKEN);
    </script>
    
    <!-- Include our AI features script -->
    <script>
        // Minimal version of the analyzeWorkflowOptimization function for testing
        function analyzeWorkflowOptimization(boardId, callback) {
            console.log('analyzeWorkflowOptimization called with boardId:', boardId);
            
            const aiSpinner = document.getElementById('workflow-ai-spinner');
            const analyzeButton = document.getElementById('analyze-workflow-btn');
            
            console.log('Elements found:', { aiSpinner, analyzeButton });
            
            if (aiSpinner) {
                aiSpinner.classList.remove('d-none');
                console.log('Spinner shown');
            }
            if (analyzeButton) {
                analyzeButton.disabled = true;
                console.log('Button disabled');
            }
            
            // Simulate API call
            setTimeout(() => {
                console.log('Simulated API call complete');
                if (aiSpinner) {
                    aiSpinner.classList.add('d-none');
                    console.log('Spinner hidden');
                }
                if (analyzeButton) {
                    analyzeButton.disabled = false;
                    console.log('Button enabled');
                }
                
                if (callback) {
                    callback(null, {
                        overall_health_score: 75,
                        analysis_summary: "Test analysis",
                        recommendations: []
                    });
                }
            }, 2000);
        }
        
        function displayWorkflowOptimization(data) {
            console.log('displayWorkflowOptimization called with:', data);
            const container = document.getElementById('workflow-optimization-container');
            const placeholder = document.getElementById('workflow-optimization-placeholder');
            const content = document.getElementById('workflow-optimization-content');
            
            if (container && content) {
                content.innerHTML = '<p>Test workflow optimization result: Health Score ' + data.overall_health_score + '</p>';
                container.classList.remove('d-none');
                if (placeholder) placeholder.style.display = 'none';
                console.log('Results displayed');
            }
        }
        
        function initWorkflowOptimization() {
            console.log('initWorkflowOptimization called');
            const analyzeButton = document.getElementById('analyze-workflow-btn');
            if (!analyzeButton) {
                console.error('Analyze button not found!');
                return;
            }
            
            console.log('Adding click listener to button');
            analyzeButton.addEventListener('click', function() {
                const boardId = this.dataset.boardId;
                console.log('Button clicked, boardId:', boardId);
                
                if (!boardId) {
                    console.error('Board ID not found');
                    alert('Board ID not found. Please refresh the page and try again.');
                    return;
                }
                
                analyzeWorkflowOptimization(boardId, function(error, data) {
                    if (error) {
                        console.error('Error:', error);
                        alert('Failed to analyze workflow: ' + error.message);
                        return;
                    }
                    
                    console.log('Success:', data);
                    displayWorkflowOptimization(data);
                });
            });
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            initWorkflowOptimization();
        });
    </script>
    
    <style>
        .d-none { display: none !important; }
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #workflow-optimization-container { margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</body>
</html>
