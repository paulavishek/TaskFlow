<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-csrf-token-12345">
    <title>Workflow Optimization JavaScript Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-panel {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .loading {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Workflow Optimization JavaScript Debug</h1>
    
    <div class="debug-panel">
        <h3>Test Environment</h3>
        <p><strong>Server URL:</strong> http://127.0.0.1:8000</p>
        <p><strong>API Endpoint:</strong> /api/analyze-workflow-optimization/</p>
        <p><strong>Chart.js Version:</strong> <span id="chartjs-version">Loading...</span></p>
        <p><strong>CSRF Token:</strong> <span id="csrf-token">Loading...</span></p>
    </div>

    <div class="debug-panel">
        <h3>Test Controls</h3>
        <button onclick="testCSRFToken()">Test CSRF Token Detection</button>
        <button onclick="testChartJS()">Test Chart.js</button>
        <button onclick="testAPICall()">Test API Call</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="debug-panel">
        <h3>Workflow Optimization Test</h3>
        <button onclick="testWorkflowOptimization()">
            <span id="workflow-spinner" style="display: none;" class="loading"></span>
            Test Workflow Optimization
        </button>
        <div id="workflow-result"></div>
    </div>

    <div class="debug-panel">
        <h3>Chart Test Area</h3>
        <canvas id="test-chart" width="400" height="200"></canvas>
    </div>

    <div class="debug-panel">
        <h3>Debug Log</h3>
        <div id="debug-log" class="log"></div>
    </div>

    <script>
        // Global variables for debugging
        window.debugLog = [];
        
        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            window.debugLog.push(logEntry);
            console.log(logEntry);
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logDiv = document.getElementById('debug-log');
            logDiv.innerHTML = window.debugLog.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            window.debugLog = [];
            updateLogDisplay();
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('Page loaded, initializing tests...');
            
            // Check Chart.js
            if (typeof Chart !== 'undefined') {
                document.getElementById('chartjs-version').textContent = Chart.version || 'Available';
                log('Chart.js loaded successfully');
            } else {
                document.getElementById('chartjs-version').textContent = 'Not loaded';
                log('Chart.js not loaded!', 'error');
            }
            
            // Check CSRF token
            const csrfToken = getCSRFToken();
            document.getElementById('csrf-token').textContent = csrfToken ? csrfToken.substring(0, 20) + '...' : 'Not found';
            log(`CSRF token: ${csrfToken ? 'Found' : 'Not found'}`);
        });
        
        // CSRF Token detection (same as in ai_features.js)
        function getCSRFToken() {
            log('Attempting to get CSRF token...');
            
            // Method 1: Meta tag
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                const token = metaToken.getAttribute('content');
                log(`CSRF token found in meta tag: ${token.substring(0, 10)}...`);
                return token;
            }
            
            // Method 2: Cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    log(`CSRF token found in cookie: ${value.substring(0, 10)}...`);
                    return value;
                }
            }
            
            // Method 3: Global variable
            if (typeof window.csrfToken !== 'undefined') {
                log(`CSRF token found in global variable: ${window.csrfToken.substring(0, 10)}...`);
                return window.csrfToken;
            }
            
            // Method 4: Hidden input
            const hiddenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (hiddenInput) {
                const token = hiddenInput.value;
                log(`CSRF token found in hidden input: ${token.substring(0, 10)}...`);
                return token;
            }
            
            log('CSRF token not found!', 'error');
            return null;
        }
        
        function testCSRFToken() {
            log('=== Testing CSRF Token Detection ===');
            const token = getCSRFToken();
            
            if (token) {
                document.getElementById('workflow-result').innerHTML = 
                    `<div class="success">âœ“ CSRF Token found: ${token.substring(0, 20)}...</div>`;
                log('CSRF token test passed', 'success');
            } else {
                document.getElementById('workflow-result').innerHTML = 
                    '<div class="error">âœ— CSRF Token not found</div>';
                log('CSRF token test failed', 'error');
            }
        }
        
        function testChartJS() {
            log('=== Testing Chart.js ===');
            
            try {
                // Destroy existing chart if any
                const existingChart = Chart.getChart('test-chart');
                if (existingChart) {
                    existingChart.destroy();
                    log('Destroyed existing chart');
                }
                
                // Create test chart
                const ctx = document.getElementById('test-chart').getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['To Do', 'In Progress', 'Done'],
                        datasets: [{
                            label: 'Tasks',
                            data: [3, 2, 5],
                            backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Chart.js Test'
                            }
                        }
                    }
                });
                
                document.getElementById('workflow-result').innerHTML = 
                    '<div class="success">âœ“ Chart.js test passed - Chart created successfully</div>';
                log('Chart.js test passed', 'success');
                
            } catch (error) {
                document.getElementById('workflow-result').innerHTML = 
                    `<div class="error">âœ— Chart.js test failed: ${error.message}</div>`;
                log(`Chart.js test failed: ${error.message}`, 'error');
            }
        }
        
        function testAPICall() {
            log('=== Testing API Call ===');
            
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                document.getElementById('workflow-result').innerHTML = 
                    '<div class="error">âœ— Cannot test API - CSRF token not found</div>';
                log('API test skipped - no CSRF token', 'error');
                return;
            }
            
            // Test with a mock board ID
            const testData = {
                board_id: 1  // Mock board ID
            };
            
            log(`Making API call to /api/analyze-workflow-optimization/ with data: ${JSON.stringify(testData)}`);
            
            fetch('http://127.0.0.1:8000/api/analyze-workflow-optimization/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(testData)
            })
            .then(response => {
                log(`API response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('workflow-result').innerHTML = 
                    '<div class="success">âœ“ API call successful</div>';
                log(`API call successful: ${JSON.stringify(data)}`, 'success');
            })
            .catch(error => {
                document.getElementById('workflow-result').innerHTML = 
                    `<div class="error">âœ— API call failed: ${error.message}</div>`;
                log(`API call failed: ${error.message}`, 'error');
            });
        }
        
        function testWorkflowOptimization() {
            log('=== Testing Complete Workflow Optimization ===');
            
            const spinner = document.getElementById('workflow-spinner');
            const resultDiv = document.getElementById('workflow-result');
            
            spinner.style.display = 'inline-block';
            resultDiv.innerHTML = '<div>Testing workflow optimization...</div>';
            
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                spinner.style.display = 'none';
                resultDiv.innerHTML = '<div class="error">âœ— CSRF token not available</div>';
                log('Workflow optimization test failed - no CSRF token', 'error');
                return;
            }
            
            // Simulate the actual workflow optimization call
            const testData = {
                board_id: 1  // This would normally come from the current board
            };
            
            log('Making workflow optimization API call...');
            
            fetch('http://127.0.0.1:8000/api/analyze-workflow-optimization/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(testData)
            })
            .then(response => {
                log(`Response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                spinner.style.display = 'none';
                
                let resultHTML = '<div class="success">âœ“ Workflow optimization successful!</div>';
                resultHTML += '<div style="margin-top: 10px;"><strong>Response:</strong><br>';
                resultHTML += `<pre style="background: #f9f9f9; padding: 10px; border-radius: 3px;">${JSON.stringify(data, null, 2)}</pre></div>`;
                
                resultDiv.innerHTML = resultHTML;
                log('Workflow optimization test passed', 'success');
                log(`Response data: ${JSON.stringify(data)}`);
                
            })
            .catch(error => {
                spinner.style.display = 'none';
                resultDiv.innerHTML = `<div class="error">âœ— Workflow optimization failed: ${error.message}</div>`;
                log(`Workflow optimization test failed: ${error.message}`, 'error');
            });
        }
    </script>
</body>
</html>
